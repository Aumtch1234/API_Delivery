const pool = require('../../config/db');
const bcrypt = require('bcrypt');
const { uploadToCloudinary } = require('../../utils/Rider/cloudinary');

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rider ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£phone
exports.updateRiderPhone = async (req, res) => {
    const { phone } = req.body;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!phone) {
        return res.status(400).json({
            error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (10 ‡∏´‡∏•‡∏±‡∏Å)
    const phonePattern = /^[0-9]{10}$/;
    if (!phonePattern.test(phone)) {
        return res.status(400).json({
            error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å)'
        });
    }

    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const existingPhone = await pool.query(
            'SELECT user_id FROM users WHERE phone = $1 AND user_id != $2',
            [phone, req.user.user_id]
        );

        if (existingPhone.rows.length > 0) {
            return res.status(400).json({
                error: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
            });
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• phone ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á users
        await pool.query(
            'UPDATE users SET phone = $1 WHERE user_id = $2',
            [phone, req.user.user_id]
        );

        res.json({
            message: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
        });
    } catch (error) {
        console.error('Error updating rider phone:', error);
        res.status(500).json({
            error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'
        });
    }
};

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rider ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay
exports.updateRiderPromptPay = async (req, res) => {
    const { promptpay } = req.body;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!promptpay) {
        return res.status(400).json({
            error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay'
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö PromptPay (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 10 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å)
    const phonePattern = /^[0-9]{10}$/;
    const idCardPattern = /^[0-9]{13}$/;
    
    if (!phonePattern.test(promptpay) && !idCardPattern.test(promptpay)) {
        return res.status(400).json({
            error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö PromptPay ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 10 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å)'
        });
    }

    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ PromptPay ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const existingPromptPay = await pool.query(
            'SELECT user_id FROM rider_profiles WHERE promptpay = $1 AND user_id != $2',
            [promptpay, req.user.user_id]
        );

        if (existingPromptPay.rows.length > 0) {
            return res.status(400).json({
                error: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
            });
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rider_profiles
        const result = await pool.query(
            'UPDATE rider_profiles SET promptpay = $1 WHERE user_id = $2',
            [promptpay, req.user.user_id]
        );

        if (result.rowCount === 0) {
            return res.status(404).json({
                error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡πà‡∏≠‡∏ô'
            });
        }

        res.json({
            message: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
        });
    } catch (error) {
        console.error('Error updating rider promptpay:', error);
        res.status(500).json({
            error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay'
        });
    }
};

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏û‡∏®
exports.updateRiderGender = async (req, res) => {
    const { gender } = req.body;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (gender === undefined || gender === null) {
        return res.status(400).json({
            error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏®'
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏®‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0 = ‡∏ä‡∏≤‡∏¢, 1 = ‡∏´‡∏ç‡∏¥‡∏á, 2 = ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
    if (![0, 1, 2].includes(parseInt(gender))) {
        return res.status(400).json({
            error: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏®‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0 = ‡∏ä‡∏≤‡∏¢, 1 = ‡∏´‡∏ç‡∏¥‡∏á, 2 = ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)'
        });
    }

    try {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏û‡∏®‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• users
        await pool.query(
            'UPDATE users SET gender = $1 WHERE user_id = $2',
            [parseInt(gender), req.user.user_id]
        );

        const genderText = {0: '‡∏ä‡∏≤‡∏¢', 1: '‡∏´‡∏ç‡∏¥‡∏á', 2: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}[parseInt(gender)];
        res.json({
            message: `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏û‡∏®‡πÄ‡∏õ‡πá‡∏ô ${genderText} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`
        });
    } catch (error) {
        console.error('Error updating rider gender:', error);
        res.status(500).json({
            error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏û‡∏®'
        });
    }
};

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
exports.updateRiderBirthdate = async (req, res) => {
    const { birthdate } = req.body;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!birthdate) {
        return res.status(400).json({
            error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î'
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD)
    const datePattern = /^\d{4}-\d{2}-\d{2}$/;
    if (!datePattern.test(birthdate)) {
        return res.status(400).json({
            error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD)'
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const date = new Date(birthdate);
    if (isNaN(date.getTime()) || date.toISOString().split('T')[0] !== birthdate) {
        return res.status(400).json({
            error: '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 18 ‡∏õ‡∏µ)
    // const today = new Date();
    // const age = today.getFullYear() - date.getFullYear();
    // const monthDiff = today.getMonth() - date.getMonth();
    
    // if (age < 18 || (age === 18 && monthDiff < 0) || 
    //     (age === 18 && monthDiff === 0 && today.getDate() < date.getDate())) {
    //     return res.status(400).json({
    //         error: '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 18 ‡∏õ‡∏µ'
    //     });
    // }

    try {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• users
        await pool.query(
            'UPDATE users SET birthdate = $1 WHERE user_id = $2',
            [birthdate, req.user.user_id]
        );

        res.json({
            message: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
        });
    }
    catch (error) {
        console.error('Error updating rider birthdate:', error);
        return res.status(500).json({
            error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î'
        });
    }
};

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
exports.updateRiderPhoto = async (req, res) => {
    try {
        let photo_url = null;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (req.file) {
            // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á Cloudinary
            const uploadResult = await uploadToCloudinary(req.file.buffer, 'rider-profiles');
            photo_url = uploadResult.secure_url;
        } else if (req.body.photo_url) {
            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á URL ‡∏°‡∏≤‡∏ï‡∏£‡∏á ‡πÜ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility)
            photo_url = req.body.photo_url;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö URL
            try {
                new URL(photo_url);
            } catch (e) {
                return res.status(400).json({
                    error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
                });
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Cloudinary ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!photo_url.includes('cloudinary.com') && !photo_url.includes('res.cloudinary.com')) {
                return res.status(400).json({
                    error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Cloudinary ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'
                });
            }
        } else {
            return res.status(400).json({
                error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á photo_url'
            });
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• users
        await pool.query(
            'UPDATE users SET photo_url = $1 WHERE user_id = $2',
            [photo_url, req.user.user_id]
        );

        res.json({
            message: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            photo_url: photo_url
        });
    } catch (error) {
        console.error('Error updating rider photo:', error);
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏Ç‡∏≠‡∏á Cloudinary
        if (error.message && error.message.includes('cloudinary')) {
            return res.status(400).json({
                error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
            });
        }
        
        res.status(500).json({
            error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå'
        });
    }
};

// ‚úÖ POST /rider/shop-closed
exports.reportShopClosed = async (req, res) => {
  try {
    const user_id = req.user.user_id; // ‡∏°‡∏≤‡∏à‡∏≤‡∏Å token
    const { market_id, order_id, reason, note } = req.body;

    // ‡∏´‡∏≤ rider_id ‡∏à‡∏≤‡∏Å rider_profiles
    const riderRes = await pool.query(
      `SELECT rider_id FROM rider_profiles WHERE user_id = $1`,
      [user_id]
    );

    if (riderRes.rows.length === 0) {
      return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });
    }

    const rider_id = riderRes.rows[0].rider_id;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ
    const imageUrls = (req.files || []).map(
      file => `${req.protocol}://${req.get('host')}/uploads/shop_closed/${file.filename}`
    );

    // insert
    const result = await pool.query(
      `INSERT INTO shop_closed_reports 
         (rider_id, market_id, order_id, reason, note, image_urls, status)
       VALUES ($1,$2,$3,$4,$5,$6,'pending')
       RETURNING *`,
      [rider_id, market_id, order_id || null, reason, note || null, imageUrls]
    );

    res.status(201).json({
      message: "‡πÅ‡∏à‡πâ‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ",
      data: result.rows[0],
    });
  } catch (err) {
    console.error("‚ùå Error in reportShopClosed:", err);
    res.status(500).json({ error: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î" });
  }
};


// ‚úÖ GET /rider/shop-closed
exports.getShopClosedReports = async (req, res) => {
  try {
    console.log("üîé JWT payload:", req.user);
    const user_id = req.user?.user_id;

    if (!user_id) {
      return res.status(400).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö user_id ‡πÉ‡∏ô token" });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rider_id ‡∏à‡∏≤‡∏Å user_id ‡∏î‡πâ‡∏ß‡∏¢ join
    const result = await pool.query(
      `
      SELECT scr.*, 
             u.display_name AS rider_name,
             u.email AS rider_email,
             u.photo_url AS rider_photo,
             rp.rider_id
      FROM shop_closed_reports scr
      JOIN rider_profiles rp ON scr.rider_id = rp.rider_id
      JOIN users u ON rp.user_id = u.user_id
      WHERE u.user_id = $1
      ORDER BY scr.created_at DESC
      `,
      [user_id]
    );

    console.log("üì¶ Found rows:", result.rows.length);

    res.json({
      success: true,
      count: result.rows.length,
      data: result.rows,
    });
  } catch (err) {
    console.error("‚ùå Error fetching shopClosed reports:", err);
    res
      .status(500)
      .json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ" });
  }
};

